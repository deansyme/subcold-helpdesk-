generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DATABASE_URL_UNPOOLED")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String
  password  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Category {
  id           String                @id @default(cuid())
  name         String
  slug         String                @unique
  description  String?
  icon         String                @default("HelpCircle")
  order        Int                   @default(0)
  isActive     Boolean               @default(true)
  createdAt    DateTime              @default(now())
  updatedAt    DateTime              @updatedAt
  articles     Article[]
  translations CategoryTranslation[]
}

model Article {
  id           String               @id @default(cuid())
  title        String
  slug         String               @unique
  content      String
  excerpt      String?
  isPopular    Boolean              @default(false)
  isPublished  Boolean              @default(true)
  viewCount    Int                  @default(0)
  locale       String               @default("en")
  categoryId   String
  category     Category             @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  translations ArticleTranslation[]
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt

  @@index([categoryId])
  @@index([isPopular])
  @@index([isPublished])
  @@index([locale])
}

model ArticleTranslation {
  id        String   @id @default(cuid())
  articleId String
  article   Article  @relation(fields: [articleId], references: [id], onDelete: Cascade)
  locale    String
  title     String
  content   String
  excerpt   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([articleId, locale])
  @@index([locale])
}

model CategoryTranslation {
  id          String   @id @default(cuid())
  categoryId  String
  category    Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  locale      String
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([categoryId, locale])
  @@index([locale])
}

model SiteSettings {
  id                 String  @id @default("default")
  siteName           String  @default("Subcold Support")
  heroTitle          String  @default("HOW CAN WE HELP?")
  heroSubtitle       String?
  contactFormEmbed   String?
  footerText         String?
  primaryColor       String  @default("#00B4D8")
  logoUrl            String  @default("https://subcold.com/cdn/shop/files/subcold-logo-white_39563153-4a05-4674-b976-f96a36b48c2c.png?v=1760517416&width=156")
}

// Unified ticket system
model Ticket {
  id           String   @id @default(cuid())
  ticketNumber String   @unique // Human-readable ticket number like TKT-001234
  type         String   // return, enquiry, support, complaint
  status       String   @default("open") // open, in-progress, awaiting-customer, resolved, closed
  priority     String   @default("normal") // low, normal, high, urgent
  
  // Customer info
  fullName     String
  email        String
  phone        String?
  
  // Ticket content
  subject      String
  message      String   @db.Text
  
  // For return tickets
  orderNumber     String?
  purchaseChannel String?
  returnReason    String?
  unwantedReason  String?
  productName     String?
  serialNumber    String?
  troubleshooting String?
  wantsReplacement String?
  
  // Attachments (photo URLs)
  attachments  String[]
  
  // Admin fields
  assignedTo   String?
  adminNotes   String?  @db.Text
  
  // Replies
  replies      TicketReply[]
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([type])
  @@index([status])
  @@index([priority])
  @@index([email])
  @@index([orderNumber])
  @@index([ticketNumber])
}

// Ticket replies/conversation thread
model TicketReply {
  id        String   @id @default(cuid())
  ticketId  String
  ticket    Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  
  type      String   @default("reply") // "reply" or "note"
  sender    String   // "admin" or "customer"
  senderName String  // Name of person who sent
  senderEmail String // Email of sender
  message   String   @db.Text
  attachments String[] // URLs of uploaded files
  
  // For email tracking (only for replies, not notes)
  emailSent Boolean  @default(false)
  emailError String?
  
  createdAt DateTime @default(now())
  
  @@index([ticketId])
}

// Keep legacy ReturnRequest for backwards compatibility, flag as deprecated
model ReturnRequest {
  id               String   @id @default(cuid())
  returnReason     String   // Unwanted, Damage, Faulty
  unwantedReason   String?  // Sub-reason for unwanted
  fullName         String
  email            String
  orderNumber      String
  purchaseChannel  String
  productName      String?
  serialNumber     String?
  troubleshooting  String?  // Have they followed manual steps
  description      String?
  wantsReplacement String?
  photoUrls        String[] // Array of uploaded photo URLs
  status           String   @default("pending") // pending, in-review, approved, rejected, completed
  adminNotes       String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([status])
  @@index([email])
  @@index([orderNumber])
}

model ReturnFormConfig {
  id                    String   @id @default("default")
  products              Json     // Array of product objects with name and requiresSerial
  purchaseChannels      Json     // Array of channel names
  unwantedReasons       Json     // Array of reason strings
  returnReasons         Json     // Array of return reason options (Unwanted, Damage, Faulty)
  replacementOptions    Json     // Array of replacement preference options
  troubleshootingOptions Json    // Array of troubleshooting question options
  formTitle             String   @default("Self-Return Request Form")
  formDescription       String?
  successTitle          String   @default("Request Submitted Successfully!")
  successMessage        String   @default("We have received your self-return request. Our team will review your submission and get back to you within 1-2 working days.")
  requirePhotoForDamage Boolean  @default(true)
  updatedAt             DateTime @updatedAt
}

